# 버스 데이터 분석 과정

## (1) bus_main.parquet_processing
* 내용 : 2018-2021년까지의 버스 일별 이용자 수에 관한 데이터
* 과정 
    ### 1. 데이터 병합
    * 원본데이터는 2018년 1월부터 2021년 10월까지 한달 단위로 csv파일로 이루어져 있음. 총(46개의 csv이며, csv당 120만 row로 이루어져 있음.)

        [출처] https://data.seoul.go.kr/
    * 파이썬 라이브러리인 glob 모듈을 이용하여 csv를 합침.
    * 합치는 과정에서 csv파일마다 컬럼명과 인코딩 방식이 모두 달라서 합쳐지지 않았음. 그래서 spark를 이용해 컬럼명을 2021년 10월 컬럼명을 기준으로 다 같게 해주었으며, 인코딩은 euc-kr 형식으로 나타내었음.

    ### 2. 데이터 전처리
    * 필요한 컬럼 : 일별 이용자 수를 알아보기 위해 "사용일자" 컬럼과 "승차총승객수" 컬럼과 "하차총승객수" 컬럼이 필요함.
    * 데이터타입 변환
    <!--tabe-->
    |사용일자|승차총승객수|하차총승객수|
    |:--:|:--:|:--:|
    |date|int|int|

     * 필요없는 컬럼 제거 : "노선번호", "노선명", "버스정류장ARS번호", "역명", "등록일자" 컬럼 제거.
    * "승차총승객수" 컬럼과 "하차총승객수" 컬럼의 Null값과 이상치를 확인하였음.

    ### 3. 데이터 분석
    * 일별 이용자 수 컬럼 생성 : 승차총승객수 + 하차총승객수를 구한 값을 일별 이용자 수로 나타냄.
    * 예시 
    <!--tabe-->
    |사용일자|일별이용자수|
    |:--:|:--:|
    |date|int|
    |2021-10-31|2631497|

    * parquet 저장 : bus_main.parquet으로 저장.

    ### 4. 특이사항
    * 하나의 csv 파일이 row가 약 120만 줄로 되어 있어서 csv파일을 열었을 때 전체 데이터를 다 못보여 준다는 것을 확인하였다.

        해결 : csv파일을 보려면 txt파일로 변환해서 나타내면 데이터를 볼 수 있다는 것을 알게되었음.
    
    * 46개의 csv파일을 다 합쳤더니 row가 약 5000만 이상이고, 크기가 10만KB였다. pandas를 이용하려 하였으나 파일을 읽는데 시간이 오래걸리며, 컴퓨터가 블루 스크린이 발생하여 컴퓨터의 LAM 공간을 많이 차지한다는 것을 확인하였다.

        해결 : 컴퓨터의 LAM이 8GB여서 공간이 부족함을 알았고 LAM 8GB를 추가해 블루스크린을 막았으며, spark를 이용하였더니 파일을 읽는데 시간이 단축되는 것을 알게되었음.
    
    * 확인차 그래프를 그려보았더니 2018년 5월12일 일별 이용자 수가 다른 날짜보다 월등하게 이용자수가 낮았다.

        해결 : 원본데이터를 확인해보니 2018년 5월 12일에 100번 버스 데이터만 있음을 확인하였다. 그래서 2018년 5월12일 데이터를 삭제하기로 결정함.

___
___
## (2) bus_second.parquet_processing
* 내용 : 2018년 1월20일(코로나 시작)-2021년까지의 버스 주별 이용자 수에 관한 데이터
* 과정 
    ### 1. 데이터 불러오기
    위 (1)번에서 병합한 csv파일을 이용하였고, bus_main.parquet을 불러옴.

    ### 2. 데이터 전처리
    * 필요한 컬럼 : 주별 이용자 수를 알아보기 위해 "사용일자" 컬럼과 "일별이용자수" 컬럼을 주별로 나눈 "주별아용자수" 컬럼이 필요함
    * 데이터타입 변환
    <!--tabe-->
    |사용일자|일별이용자수|
    |:--:|:--:|
    |date|int|

    * "일별이용자수" 컬럼의 Null값과 이상치를 확인하였음.

    ### 3. 데이터 분석
    * 주별 이용자 수 컬럼 생성 : resample함수를 이용하여 일별을 주별로 바꿔줌. (이 때 날짜가 일요일로 기준이 되어있어서 가시성을 위해 월요일 기준으로 바꿔주었음)

    * 예시 
    <!--tabe-->
    |사용일자|주별이용자수|
    |:--:|:--:|
    |date|int|
    |2021-10-25|29720831|

    * parquet 저장 : bus_second.parquet으로 저장.

    ### 4. 특이사항
    * 특이사항 없음
    
___
___
## (3) bus_third.parquet_processing
* 내용 : 2018년-2021년까지의 버스 종류별 평균 승차 인원 수에 관한 데이터 
* 과정 
    ### 1. 데이터 불러오기
    위 (1)번에서 병합한 csv파일을 이용함.

    ### 2. 데이터 전처리
    * 필요한 컬럼 : 코로나 이전/이후 버스 종류별로 데이터를 나타내야 하므로, "코로나"컬럼과 "버스종류" 컬럼과 "버스별이용자수" 컬럼이 필요함.
    * 데이터타입 변환
    <!--tabe-->
    |사용일자|승차총승객수|
    |:--:|:--:|
    |date|int|

    * "승차총승객수" 컬럼의 Null값과 이상치를 확인하였음.
    * 버스 종류 컬럼 생성 : 간선/지선/광역/순환/마을/심야버스를 구분 지어줘야 하므로, 각각의 노선번호를 해당 버스종류의 리스트화 시켜서 컬럼을 생성시킴.
    (이 때 노선번호는 총 649개, 아래 나무위키 사이트를 참조하여 현재 운행하는 버스의 종류를 나눔)
    [출처] https://namu.wiki/w/%EC%84%9C%EC%9A%B8%ED%8A%B9%EB%B3%84%EC%8B%9C%20%EC%8B%9C%EB%82%B4%EB%B2%84%EC%8A%A4 
    * 코로나 컬럼 생성 : 버스 종류별 코로나 이전 이후 변화를 비교해야하므로 2020-01-20 이전이면 previous, 2020-01-20 이후이면 post로 나타나게 함.

    ### 3. 데이터 분석
    * 전처리 한 데이터를 가지고 코로나와 버스종류를 기준으로 groupby를 이용해 숭차총승객수의 평균을 구해줌.

    * 예시 
    <!--tabe-->
    |코로나|버스종류|버스별이용자수|
    |:--:|:--:|:--:|
    |string|string|int|
    |post|지선|93.822867|

    * parquet 저장 : bus.third.parquet으로 저장.

    ### 4. 특이사항
    * "버스종류" 컬럼을 생성하는데 현재 운행이 종료되거나 노선번호가 변경된 버스가 존재

        해결 : chain 모듈을 아용하여 변경할 버스를 dictionary로 생성하여 노선번호를 변경 사켜주고, 폐지된 노선번호는 평균 승차인원을 집계 하므로 기존 노선번호 리스트에 추가해줌.

        예시 :

    1)) 간선버스
    * 108 >> 2021년 8월 2일 폐지
    * 407 >> 2018년 8월 24일 폐지
    * 775 >> 2018년 5월 1일 폐지
    * 271A >> 271번으로 명칭 변경
    * 271B >> 2021년 3월 27일 폐지
    * 462 >> 452로 명칭 변경
    * 471 >> 741로 명칭 변경
    * 670 >> 660으로 명칭 변경
    * 751 >> 741로 명칭 변경
    
    2)) 지선버스
    * 1166 >> 2018년 8월 24일 폐지
    * 4412 >> 4312로 명칭 변경
    * 5522A >> 5522로 명칭 변경
    * 5522B >> 5522로 명칭 변경
    * 5534 >> 5634로 명칭 변경
    * 8111 >> 2018년 8월 27일 폐지
    
    3)) 광역버스
    * 9709 >> 2020년 폐지되었는데 파주버스로 넘어감.
    * 9711A >> 9711로 변경
    
    4)) 순환버스
    * 05 >> 2020년 1월29일 폐지
    
    5)) 심야버스
    * N824, N854, N866, N877 >> 2018년에만 운행함
    * N850 >> 2019년 12월18일부터 2020년 1월12일까지 수요일부터 일요일에만 운행함.
    * N876 >> 코로나 이후 운행 중단

___
___
## (4) bus_four.parquet_processing
### 4-1. bus_per_time.parquet
* 내용 : 2020-06 ~ 2021-10까지의 지역에 따른 시간대별 버스 평균 승차 인원 수에 관한 데이터
* 과정 
    ### 1. 데이터 병합
    * 원본데이터는 2020년 6월부터 2021년 10월까지 한달 단위로 csv파일로 이루어져 있음. 총(17개의 csv이며, csv당 약 600 row로 이루어져 있음.)

        [출처] https://insfiler.com/detail/rt_transit_time_202110-0001?category=total
    * 파이썬 라이브러리인 glob 모듈을 이용하여 csv를 합침.
    * csv파일마다 컬럼명과 인코딩 방식은 모두 같았고, 적은 데이터라서 pandas를 이용함.

    ### 2. 데이터 전처리
    * 필요한 컬럼 : 일별 이용자 수를 알아보기 위해 "날짜" 컬럼과 "지역" 컬럼과 "시간대" 컬럼과 "시간대평균(명)" 컬럼이 필요함.
    * 필요없는 컬럼 제거 : "항목", "전월시간대평균(명)", "전월대비(명)" 컬럼 제거.
    * 필요없는 컬럼값 제거 : "시간대" 컬럼에서 전체 시간대 평균은 나타낼 필요가없어서 "시간당 평균"값을 포함한 인덱스는 제거.
    * 컬럼명 이름 변경 : rename함수를 이용하여 "시간대평균(명)" 컬럼명을 "평균승차인원" 컬럼명으로 변경.
    * "시간대평균" 컬럼의 Null값과 이상치를 확인하였음.
    * 데이터타입 변환
    <!--tabe-->
    |날짜|지역|시간대|평균숭차인원|
    |:--:|:--:|:--:|:--:|
    string|string|string|float|
        날짜 컬럼을 string 타입으로 변경한 이유 : 지역과 시간대별로 그룹화했을 때 날짜도 평균으로 나타내어 지므로 string으로 변환해야함.

    ### 3. 데이터 분석
    * 전처리한 데이터를 가지고 "지역"과 "시간대" 컬럼을 기준으로 groupby를 이용해 평균 승차 인원 수를 구함.
    * 예시 
    <!--tabe-->
    |지역|시간대|평균숭차인원|
    |:--:|:--:|:--:|
    |string|string|float|
    |서울특별시 강남구|00-01시|1499.0|

    * parquet 저장 : bus_per_time.parquet으로 저장.

    ### 4. 특이사항
    * 특이사항 없음.
___
### 4-2. bus_per_day-of-week.parquet
* 내용 : 2020-06 ~ 2021-10까지의 지역에 따른 요일별 버스 평균 승차 인원 수에 관한 데이터
* 과정 
    ### 1. 데이터 병합
    * 4-1방법과 동일하게 하였음.
    [출처] https://insfiler.com/detail/rt_transit_day-0005?category=total___

    ### 2. 데이터 전처리
    * 4-1방법과 동일하게 하였음.

    ### 3. 데이터 분석
    * 전처리한 데이터를 가지고 "지역"과 "요일" 컬럼을 기준으로 groupby를 이용해 평균 승차 인원 수를 구함.
    * 가시성을 위해 "요일" 컬럼을 기준으로 정렬 (특이사항 발생)
    * 예시 
    <!--tabe-->
    |지역|요일|평균숭차인원|
    |:--:|:--:|:--:|
    |string|string|float|
    |서울특별시 강남구|월요일|1499.0|

    * parquet 저장 : bus_per_day-of-week.parquet으로 저장

    ### 4. 특이사항
    * "요일" 컬럼으로 정렬을 하는데 데이터타입이 stirng이여서 "가,나,다" 순서대로 정렬이 되는 것을 확인
    
        해결 : CategoricalDtype 모듈을 불러와서 월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일' 순서대로 정렬이 되게끔 카테고리를 설정해줌.
        설정한 카테고리로 데이터타입을 변경하니 정렬이 잘 되는 것을 확인.
